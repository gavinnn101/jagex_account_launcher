<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jagex Account Launcher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div id="app" class="container">
        <h1 class="my-4">Jagex Account Launcher</h1>
        <div id="app-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const { ref, h, createApp } = Vue;

        const NotificationAlert = {
            props: ['notification'],
            emits: ['close'],
            setup(props, { emit }) {
                return () => props.notification.message
                    ? h('div', {
                        class: ['alert', `alert-${props.notification.type || 'info'}`],
                        role: 'alert'
                    }, [
                        props.notification.message,
                        h('button', {
                            type: 'button',
                            class: 'btn-close',
                            onClick: () => emit('close'),
                            'aria-label': 'Close'
                        })
                    ])
                    : null;
            }
        };

        const DaemonsTable = {
            props: ['daemons'],
            emits: ['launch'],
            setup(props, { emit }) {
                return () => h('table', { class: 'table table-bordered' }, [
                    h('thead', {}, [
                        h('tr', {}, [
                            h('th', {}, 'Nickname'),
                            h('th', {}, 'IP Address'),
                            h('th', {}, 'Port'),
                            h('th', {}, 'Action')
                        ])
                    ]),
                    h('tbody', {}, props.daemons.length > 0
                        ? props.daemons.map(daemon =>
                            h('tr', { key: daemon.nickname }, [
                                h('td', {}, daemon.nickname),
                                h('td', {}, daemon.ip_address),
                                h('td', {}, daemon.port),
                                h('td', {}, [
                                    h('button', {
                                        class: 'btn btn-primary btn-sm',
                                        onClick: () => emit('launch', daemon.nickname)
                                    }, 'Launch Account')
                                ])
                            ])
                        )
                        : h('tr', {}, [
                            h('td', { colspan: 4, class: 'text-center' }, 'No daemons available')
                        ])
                    )
                ]);
            }
        };

        const AccountsTable = {
            props: ['accounts'],
            emits: ['edit', 'delete'],
            setup(props, { emit }) {
                return () => h('table', { class: 'table table-bordered' }, [
                    h('thead', {}, [
                        h('tr', {}, [
                            h('th', {}, 'Nickname'),
                            h('th', {}, 'JX_CHARACTER_ID'),
                            h('th', {}, 'JX_SESSION_ID'),
                            h('th', {}, 'JX_DISPLAY_NAME'),
                            h('th', {}, 'Action')
                        ])
                    ]),
                    h('tbody', {}, Object.entries(props.accounts).map(([nickname, account]) =>
                        h('tr', { key: nickname }, [
                            h('td', {}, nickname || 'Unnamed Account'),
                            h('td', {}, account.JX_CHARACTER_ID),
                            h('td', {}, account.JX_SESSION_ID),
                            h('td', {}, account.JX_DISPLAY_NAME),
                            h('td', {}, [
                                h('button', {
                                    class: 'btn btn-primary btn-sm me-2',
                                    onClick: () => emit('edit', nickname)
                                }, 'Edit'),
                                h('button', {
                                    class: 'btn btn-danger btn-sm',
                                    onClick: () => emit('delete', nickname)
                                }, 'Delete')
                            ])
                        ])
                    ))
                ]);
            }
        };

        const LaunchAccountModal = {
            props: ['show', 'accounts', 'selectedDaemon'],
            emits: ['close', 'launch'],
            setup(props, { emit }) {
                const selectedAccount = ref('');

                return () => props.show
                    ? h('div', {
                        class: 'modal fade show d-block',
                        tabindex: '-1',
                        'aria-labelledby': 'launchAccountModalLabel',
                        'aria-modal': 'true'
                    }, [
                        h('div', { class: 'modal-dialog' }, [
                            h('div', { class: 'modal-content' }, [
                                h('div', { class: 'modal-header' }, [
                                    h('h5', { class: 'modal-title', id: 'launchAccountModalLabel' }, 'Launch Account'),
                                    h('button', {
                                        type: 'button',
                                        class: 'btn-close',
                                        onClick: () => emit('close'),
                                        'aria-label': 'Close'
                                    })
                                ]),
                                h('div', { class: 'modal-body' }, [
                                    h('form', {
                                        onSubmit: (event) => {
                                            event.preventDefault();
                                            emit('launch', selectedAccount.value, props.selectedDaemon);
                                        }
                                    }, [
                                        h('div', { class: 'mb-3' }, [
                                            h('label', { for: 'accountSelect', class: 'form-label' }, 'Select Account'),
                                            h('select', {
                                                class: 'form-select',
                                                value: selectedAccount.value,
                                                onInput: (event) => { selectedAccount.value = event.target.value },
                                                required: true
                                            }, Object.entries(props.accounts).map(([nickname, account]) =>
                                                h('option', { value: nickname }, nickname || 'Unnamed Account')
                                            ))
                                        ]),
                                        h('button', {
                                            type: 'submit',
                                            class: 'btn btn-primary'
                                        }, 'Launch')
                                    ])
                                ])
                            ])
                        ])
                    ])
                    : null;
            }
        };

        const AccountModal = {
            props: ['show', 'account'],
            emits: ['close', 'save'],
            setup(props, { emit }) {
                const formData = ref({
                    nickname: '',
                    JX_CHARACTER_ID: '',
                    JX_SESSION_ID: '',
                    JX_DISPLAY_NAME: '',
                    JX_REFRESH_TOKEN: '',
                    JX_ACCESS_TOKEN: '',
                });

                const resetForm = () => {
                    formData.value = {
                        nickname: '',
                        JX_CHARACTER_ID: '',
                        JX_SESSION_ID: '',
                        JX_DISPLAY_NAME: '',
                        JX_REFRESH_TOKEN: '',
                        JX_ACCESS_TOKEN: '',
                    };
                };

                const handleSubmit = () => {
                    emit('save', formData.value);
                };

                if (props.account) {
                    formData.value = { ...props.account };
                } else {
                    resetForm();
                }

                return () => props.show
                    ? h('div', {
                        class: 'modal fade show d-block',
                        tabindex: '-1',
                        'aria-labelledby': 'accountModalLabel',
                        'aria-modal': 'true'
                    }, [
                        h('div', { class: 'modal-dialog' }, [
                            h('div', { class: 'modal-content' }, [
                                h('div', { class: 'modal-header' }, [
                                    h('h5', { class: 'modal-title', id: 'accountModalLabel' }, `${props.account ? 'Edit' : 'Add'} Account`),
                                    h('button', {
                                        type: 'button',
                                        class: 'btn-close',
                                        onClick: () => emit('close'),
                                        'aria-label': 'Close'
                                    })
                                ]),
                                h('div', { class: 'modal-body' }, [
                                    h('form', {
                                        onSubmit: (event) => {
                                            event.preventDefault();
                                            handleSubmit();
                                        }
                                    }, [
                                        h('div', { class: 'mb-3' }, [
                                            h('label', { for: 'accountNickname', class: 'form-label' }, 'Account Nickname'),
                                            h('input', {
                                                type: 'text',
                                                class: 'form-control',
                                                id: 'accountNickname',
                                                value: formData.value.nickname,
                                                onInput: (event) => { formData.value.nickname = event.target.value },
                                                required: true
                                            })
                                        ]),
                                        h('div', { class: 'mb-3' }, [
                                            h('label', { for: 'jxCharacterId', class: 'form-label' }, 'JX_CHARACTER_ID'),
                                            h('input', {
                                                type: 'text',
                                                class: 'form-control',
                                                id: 'jxCharacterId',
                                                value: formData.value.JX_CHARACTER_ID,
                                                onInput: (event) => { formData.value.JX_CHARACTER_ID = event.target.value },
                                                required: true
                                            })
                                        ]),
                                        h('div', { class: 'mb-3' }, [
                                            h('label', { for: 'jxSessionId', class: 'form-label' }, 'JX_SESSION_ID'),
                                            h('input', {
                                                type: 'text',
                                                class: 'form-control',
                                                id: 'jxSessionId',
                                                value: formData.value.JX_SESSION_ID,
                                                onInput: (event) => { formData.value.JX_SESSION_ID = event.target.value },
                                                required: true
                                            })
                                        ]),
                                        h('div', { class: 'mb-3' }, [
                                            h('label', { for: 'jxDisplayName', class: 'form-label' }, 'JX_DISPLAY_NAME'),
                                            h('input', {
                                                type: 'text',
                                                class: 'form-control',
                                                id: 'jxDisplayName',
                                                value: formData.value.JX_DISPLAY_NAME,
                                                onInput: (event) => { formData.value.JX_DISPLAY_NAME = event.target.value },
                                                required: true
                                            })
                                        ]),
                                        h('div', { class: 'mb-3' }, [
                                            h('label', { for: 'jxRefreshToken', class: 'form-label' }, 'JX_REFRESH_TOKEN (Optional)'),
                                            h('input', {
                                                type: 'text',
                                                class: 'form-control',
                                                id: 'jxRefreshToken',
                                                value: formData.value.JX_REFRESH_TOKEN,
                                                onInput: (event) => { formData.value.JX_REFRESH_TOKEN = event.target.value }
                                            })
                                        ]),
                                        h('div', { class: 'mb-3' }, [
                                            h('label', { for: 'jxAccessToken', class: 'form-label' }, 'JX_ACCESS_TOKEN (Optional)'),
                                            h('input', {
                                                type: 'text',
                                                class: 'form-control',
                                                id: 'jxAccessToken',
                                                value: formData.value.JX_ACCESS_TOKEN,
                                                onInput: (event) => { formData.value.JX_ACCESS_TOKEN = event.target.value }
                                            })
                                        ]),
                                        h('button', {
                                            type: 'submit',
                                            class: 'btn btn-primary'
                                        }, 'Save Account')
                                    ])
                                ])
                            ])
                        ])
                    ])
                    : null;
            }
        };

        const app = createApp({
            components: {
                NotificationAlert,
                DaemonsTable,
                AccountsTable,
                LaunchAccountModal,
                AccountModal,
            },
            setup() {
                const daemons = ref([]);
                const accounts = ref({});
                const selectedDaemonNickname = ref('');
                const notification = ref({ type: '', message: '' });
                const showLaunchModal = ref(false);
                const showAccountModal = ref(false);
                const currentAccount = ref(null);

                const fetchDaemons = async () => {
                    try {
                        const response = await fetch('/get_daemons');
                        daemons.value = await response.json();
                    } catch (error) {
                        showNotification('danger', 'Failed to load daemons: ' + error.message);
                    }
                };

                const fetchAccounts = async () => {
                    try {
                        const response = await fetch('/get_accounts');
                        accounts.value = await response.json();
                    } catch (error) {
                        showNotification('danger', 'Failed to load accounts: ' + error.message);
                    }
                };

                const showNotification = (type, message) => {
                    notification.value = { type, message: message || 'No message provided' };
                };

                const closeNotification = () => {
                    notification.value = { type: '', message: '' };
                };

                const openLaunchModal = (daemonNickname) => {
                    selectedDaemonNickname.value = daemonNickname;
                    showLaunchModal.value = true;
                };

                const closeLaunchModal = () => {
                    showLaunchModal.value = false;
                    selectedDaemonNickname.value = '';
                };

                const launchAccount = async (accountId, daemonNickname) => {
                    try {
                        const response = await fetch('/launch_account', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ account_id: accountId, daemon_nickname: daemonNickname }),
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            showNotification('success', 'Account launched successfully!');
                        } else {
                            throw new Error(data.message);
                        }
                    } catch (error) {
                        showNotification('danger', 'Failed to launch account: ' + error.message);
                    } finally {
                        closeLaunchModal();
                    }
                };

                const openAccountModal = (account = null) => {
                    currentAccount.value = account;
                    showAccountModal.value = true;
                };

                const closeAccountModal = () => {
                    showAccountModal.value = false;
                    currentAccount.value = null;
                };

                const saveAccount = async (accountData) => {
                    try {
                        const response = await fetch('/add_account', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(accountData),
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            showNotification('success', 'Account saved successfully!');
                            await fetchAccounts();
                        } else {
                            throw new Error(data.message);
                        }
                    } catch (error) {
                        showNotification('danger', 'Failed to save account: ' + error.message);
                    } finally {
                        closeAccountModal();
                    }
                };

                const deleteAccount = async (nickname) => {
                    if (confirm("Are you sure you want to delete this account?")) {
                        try {
                            const response = await fetch('/delete_account', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ nickname }),
                            });
                            const data = await response.json();
                            if (data.status === 'success') {
                                showNotification('success', 'Account deleted successfully!');
                                await fetchAccounts();
                            } else {
                                throw new Error(data.message);
                            }
                        } catch (error) {
                            showNotification('danger', 'Failed to delete account: ' + error.message);
                        }
                    }
                };

                // Initial data fetch
                fetchDaemons();
                fetchAccounts();

                // Set up interval for refreshing daemons
                setInterval(fetchDaemons, 5000);

                return () => h('div', [
                    h(NotificationAlert, {
                        notification: notification.value,
                        onClose: closeNotification
                    }),
                    h('ul', { class: 'nav nav-tabs mb-3' }, [
                        h('li', { class: 'nav-item' }, [
                            h('a', {
                                class: 'nav-link active',
                                id: 'daemons-tab',
                                'data-bs-toggle': 'tab',
                                href: '#daemons',
                                role: 'tab',
                                'aria-controls': 'daemons',
                                'aria-selected': 'true'
                            }, 'Daemons')
                        ]),
                        h('li', { class: 'nav-item' }, [
                            h('a', {
                                class: 'nav-link',
                                id: 'accounts-tab',
                                'data-bs-toggle': 'tab',
                                href: '#accounts',
                                role: 'tab',
                                'aria-controls': 'accounts',
                                'aria-selected': 'false'
                            }, 'Accounts')
                        ])
                    ]),
                    h('div', { class: 'tab-content' }, [
                        h('div', {
                            class: 'tab-pane fade show active',
                            id: 'daemons',
                            role: 'tabpanel',
                            'aria-labelledby': 'daemons-tab'
                        }, [
                            h('h2', { class: 'mb-3' }, 'Daemons'),
                            h(DaemonsTable, {
                                daemons: daemons.value,
                                onLaunch: openLaunchModal
                            })
                        ]),
                        h('div', {
                            class: 'tab-pane fade',
                            id: 'accounts',
                            role: 'tabpanel',
                            'aria-labelledby': 'accounts-tab'
                        }, [
                            h('div', { class: 'd-flex justify-content-between align-items-center mb-3' }, [
                                h('h2', {}, 'Accounts'),
                                h('button', {
                                    class: 'btn btn-success',
                                    onClick: () => openAccountModal()
                                }, 'Add Account')
                            ]),
                            h(AccountsTable, {
                                accounts: accounts.value,
                                onEdit: openAccountModal,
                                onDelete: deleteAccount
                            })
                        ])
                    ]),
                    h(LaunchAccountModal, {
                        show: showLaunchModal.value,
                        accounts: accounts.value,
                        selectedDaemon: selectedDaemonNickname.value,
                        onClose: closeLaunchModal,
                        onLaunch: launchAccount
                    }),
                    h(AccountModal, {
                        show: showAccountModal.value,
                        account: currentAccount.value,
                        onClose: closeAccountModal,
                        onSave: saveAccount
                    })
                ]);
            }
        });

        app.mount('#app-content');
    </script>
</body>
</html>